<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Jekyll v4.0.1">
    <title>问题相关统计</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/dashboard/">

    <!-- Bootstrap core CSS -->
    <link href="../css/administrators/statisticsAdmin.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://lib.baomitu.com/font-awesome/5.11.2/css/all.min.css">
    <script type="text/javascript" src="https://lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://lib.baomitu.com/vue/2.6.10/vue.min.js"></script>
    <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
    </style>
    <!-- Custom styles for this template -->
    <link href="dashboard.css" rel="stylesheet">
</head>
<body>
<div id="index">
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#">IKnow</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <input class="form-control form-control-dark w-100" type="text" placeholder="搜索" aria-label="Search">
        <ul class="navbar-nav px-5">
            <li class="nav-item text-nowrap">
                <a class="nav-link" href="#">搜索</a>
            </li>
        </ul>
        <ul class="navbar-nav px-3" style="background-color: crimson">
            <li class="nav-item text-nowrap">
                <a class="nav-link" href="#" @click="logout">登出</a>
            </li>
        </ul>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <span data-feather="home"></span>
                                问题举报 <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file"></span>
                                回答举报
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="shopping-cart"></span>
                                评论举报
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="users"></span>
                                回复举报
                            </a>
                        </li>
                    </ul>
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>学校管理</span>
                        <!--                    <a class="d-flex align-items-center text-muted" href="#" aria-label="Add a new report">-->
                        <!--                        <span data-feather="plus-circle"></span>-->
                        <!--                    </a>-->
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="statisticsUserAdmin.html">
                                <span data-feather="file-text"></span>
                                学校管理
                            </a>
                        </li>
                    </ul>
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>相关统计</span>
                        <!--                    <a class="d-flex align-items-center text-muted" href="#" aria-label="Add a new report">-->
                        <!--                        <span data-feather="plus-circle"></span>-->
                        <!--                    </a>-->
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="statisticsUserAdmin.html">
                                <span data-feather="file-text"></span>
                                用户统计
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                问题统计
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>


            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">数据统计</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group mr-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @click="questionSum=true;questionType=true;getStatistics(getBeforeDate(0),1);getTypeStatistics()">总览</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">导出</button>
                        </div>
                        <!--                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">-->
                        <!--                            <span data-feather="calendar"></span>-->
                        <!--                            统计-->
                        <!--                        </button>-->
                        <div class="btn-group mr-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" @click="getStatistics(getBeforeDate(0),1);questionSum=true;questionType=false">总数统计</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" @click="getTypeStatistics();questionSum=false;questionType=true">类别统计</button>
                        </div>
                    </div>
                </div>
                <h2 v-if="questionSum">问题总数</h2>
                <canvas v-if="questionSum" class="my-4 w-100" id="myChart" width="900" height="380"></canvas>
                <h2 v-if="questionType">类别统计</h2>
<!--                <canvas v-if="questionType" class="my-4 w-100" id="quesType" width="900" height="380"></canvas>-->
                <div v-if="questionType" id="quesType"></div>
            </main>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.9.0/feather.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<script>
    let index=new Vue({
        el:"#index",
        data:{
            questionType:true,
            questionSum:true,
            userSums:[],
            questionSums:[],
            questionTypeSums:[],
            all: 8, //总页数
            cur: 1//当前页码
        },
        watch: {
            cur: function(oldValue , newValue){
                console.log(arguments);
            }
        },
        methods:{
            logout:function () {
                $.ajax({
                    type:"POST",
                    url:"../admin/logout.action",
                    data:{},
                    dataType:"json",
                    success:function (result) {
                        if (result.response === 0) {
                            location.href = "login.html";
                        }
                    },
                    error:function (request,status,error) {
                        alert("系统异常！");
                        console.log(request.status);
                        console.log(request.readyState);
                        console.log(status);
                    }
                });
            },
            btnClick: function(data){
                if(data != this.cur){
                    this.cur = data;
                }
            },
            pageClick: function(){
                console.log('现在在'+this.cur+'页');
            },
            isLogin:function(){
                $.ajax({
                    url: "../admin/isLogin.action",
                    type: "POST",
                    data: {},
                    dataType: "json",
                    success: function (result) {
                        if (result.resultCode === 1) {
                            location.href="login.html";
                        }
                    },
                    error: function (request, status, error) {
                        alert("系统异常！");
                        console.log(request.status);
                        console.log(request.readyState);
                        console.log(status);
                    }
                });
            },
            getBeforeDate:function(num, time) {
                let n = num;
                let d = '';
                if(time) {
                    d = new Date(time);
                } else {
                    d = new Date();
                }
                let year = d.getFullYear();
                let mon = d.getMonth() + 1;
                let day = d.getDate();
                if(day <= n) {
                    if(mon > 1) {
                        mon = mon - 1;
                    } else {
                        year = year - 1;
                        mon = 12;
                    }
                }
                d.setDate(d.getDate() - n);
                year = d.getFullYear();
                mon = d.getMonth() + 1;
                day = d.getDate();
                let s = year + "-" + (mon < 10 ? ('0' + mon) : mon) + "-" + (day < 10 ? ('0' + day) : day);
                return s;
            },
            getStatistics:function (dateNow,typeSum) {
                $.ajax({
                    url: "../admin/statistics.action",
                    type: "POST",
                    data: {
                        dateNow:dateNow,
                        typeSum:typeSum,
                    },
                    dataType: "json",
                    success: function (result) {
                        if (result.resultCode === 0) {
                            if(typeSum === 1)
                            {
                                index.userSums=result.userSums;
                                // Graphs
                                let day1=index.userSums[0].sum;
                                let day2=index.userSums[1].sum;
                                let day3=index.userSums[2].sum;
                                let day4=index.userSums[3].sum;
                                let day5=index.userSums[4].sum;
                                let day6=index.userSums[5].sum;
                                let day7=index.userSums[6].sum;
                                var ctx = document.getElementById('myChart')
                                // eslint-disable-next-line no-unused-vars
                                var myChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: [
                                            index.getBeforeDate(7),
                                            index.getBeforeDate(6),
                                            index.getBeforeDate(5),
                                            index.getBeforeDate(4),
                                            index.getBeforeDate(3),
                                            index.getBeforeDate(2),
                                            index.getBeforeDate(1)
                                        ],
                                        datasets: [{
                                            data: [
                                                day1,
                                                day2,
                                                day3,
                                                day4,
                                                day5,
                                                day6,
                                                day7
                                            ],
                                            lineTension: 0,
                                            backgroundColor: 'transparent',
                                            borderColor: '#007bff',
                                            borderWidth: 4,
                                            pointBackgroundColor: '#007bff'
                                        }]
                                    },
                                    options: {
                                        scales: {
                                            yAxes: [{
                                                ticks: {
                                                    beginAtZero: false
                                                }
                                            }]
                                        },
                                        legend: {
                                            display: false
                                        }
                                    }
                                })
                                console.log(index.userSums[0].sum);
                            }
                            if(typeSum === 0)
                            {
                                index.questionSums=result.questionSums;
                                // Graphs
                                let day1=index.questionSums[0].sum;
                                let day2=index.questionSums[1].sum;
                                let day3=index.questionSums[2].sum;
                                let day4=index.questionSums[3].sum;
                                let day5=index.questionSums[4].sum;
                                let day6=index.questionSums[5].sum;
                                let day7=index.questionSums[6].sum;
                                var ctx = document.getElementById('myChart')
                                // eslint-disable-next-line no-unused-vars
                                var myChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: [
                                            index.getBeforeDate(7),
                                            index.getBeforeDate(6),
                                            index.getBeforeDate(5),
                                            index.getBeforeDate(4),
                                            index.getBeforeDate(3),
                                            index.getBeforeDate(2),
                                            index.getBeforeDate(1)
                                        ],
                                        datasets: [{
                                            data: [
                                                day1,
                                                day2,
                                                day3,
                                                day4,
                                                day5,
                                                day6,
                                                day7
                                            ],
                                            lineTension: 0,
                                            backgroundColor: 'transparent',
                                            borderColor: '#007bff',
                                            borderWidth: 4,
                                            pointBackgroundColor: '#007bff'
                                        }]
                                    },
                                    options: {
                                        scales: {
                                            yAxes: [{
                                                ticks: {
                                                    beginAtZero: false
                                                }
                                            }]
                                        },
                                        legend: {
                                            display: false
                                        }
                                    }
                                })
                            }
                        }
                        console.log(result.resultCode);
                    },
                    error: function (request, status, error) {
                        alert("获取数据失败！");
                        console.log(request.status);
                        console.log(request.readyState);
                        console.log(status);
                    }
                });
            },
            getTypeStatistics:function () {
                $.ajax({
                    url: "../admin/questionTypeSum.action",
                    type: "POST",
                    data: {
                    },
                    dataType: "json",
                    success: function (result) {
                        if (result.resultCode === 0) {
                                index.questionTypeSums=result.questionTypeSums;
                                let len = index.questionTypeSums.length;
                                //Graphs
                                let types=[];
                                for(i=0;i<len;i++){
                                    types[i]=index.questionTypeSums[i].name;
                                }
                                let sums = new Array(len);
                                for(i=0;i<len;i++){
                                    let obj = new Object();
                                    obj.name = index.questionTypeSums[i].name;
                                    obj.value = index.questionTypeSums[i].value;
                                    sums[i]=obj;
                                }
                                var ctx = echarts.init(document.getElementById('quesType'));
                                // eslint-disable-next-line no-unused-vars
                            option = {
                                tooltip: {
                                    trigger: 'item',
                                    formatter: '问题类别: <br/>{b} : {c} ({d}%)'
                                },
                                legend: {
                                    // orient: 'vertical',
                                    // top: 'middle',
                                    bottom: 10,
                                    left: 'center',
                                    data: types
                                },
                                series: [
                                    {
                                        type: 'pie',
                                        radius: '65%',
                                        center: ['50%', '50%'],
                                        selectedMode: 'single',
                                        data: sums,
                                        emphasis: {
                                            itemStyle: {
                                                shadowBlur: 10,
                                                shadowOffsetX: 0,
                                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                                            }
                                        }
                                    }
                                ]
                            };
                            ctx.setOption(option);
                                console.log(sums);
                        }
                        console.log(result.resultCode);
                    },
                    error: function (request, status, error) {
                        alert("获取数据失败！");
                        console.log(request.status);
                        console.log(request.readyState);
                        console.log(status);
                    }
                });
            }
        },
        computed: {
            indexs: function(){
                var left = 1;
                var right = this.all;
                var ar = [];
                if(this.all>= 5){
                    //这里最大范围从3到6，如果到达7，那么下边加2变成9，已经超过最大的范围值
                    if(this.cur > 3 && this.cur < this.all-1){
                        //以4为参考基准，左面加2右边加2
                        left = this.cur - 2
                        right = this.cur + 2
                    }else{
                        if(this.cur<=3){
                            left = 1
                            right = 5
                        }else{
                            right = this.all
                            left = this.all -4
                        }
                    }
                }
                while (left <= right){
                    ar.push(left)
                    left ++
                }
                console.log(ar);
                return ar
            }
        },
        mounted:function () {
            this.isLogin();
            let date = this.getBeforeDate(0);
            this.getStatistics(date,0);
            this.getTypeStatistics();
        }

    });
    (function () {
        'use strict'

        feather.replace()

        // Graphs
        var ctx = document.getElementById('myChart')
        // eslint-disable-next-line no-unused-vars

    }())
</script>
</body>
</html>
